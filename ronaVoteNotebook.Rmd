---
title: "ronaVote"
subtitle: "Ongoing COVID and the 2020 USA Election: Time Trends and Magnitudes of Correlation among the Cross-section of Counties"
author: "Author: Steven Bhardwaj"
date: "2021-08-04"
output: 
  html_document:
    theme:
      bootswatch: darkly
    code_folding: hide
---

<style type="text/css">
*{
  margin: 0;
  padding: 0;
}
h1.title {
  padding-top: 2em;
  text-align: center;
}
h3.subtitle {
  text-align: center;
}
h4.author {
  font-size: 1em;
  text-align: center;
}
h4.date {
  font-size: 1em;
  text-align: center;
}

#homeLink {
  font-size: 1.5em;
  color: #CCCCCC !important;
  opacity: 1;
  width: 5em;
	height: 1.2em;
  position: absolute;
  top: 3%;
  left: 50%;
  transform: translate(-50%, 0%);
}
hr{
  height: 1px;
  background-color: #FFF;
  border: none;
}

</style>

<div id="homeLink"><a href="../index.html"><p align="center">
bhrdwj.net
<br>
æ½˜
</p></a></div>

## Abstract
In Spring and Summer of 2020, predominantly politically Democratic cities like NYC suffered the worst of the first COVID wave. But after the Fall and the election passed, the winter saw much worse COVID in many Republican-majority areas.

The maximum correlation of Democratic areas and cumulative severity of COVID occurred the second week of August 2020, at 8 COVID-cases per 100,000 population per percentage point of vote margin. By the second week of November, the Democratic and Republican areas had accumulated balanced counts, coinciding with the moment of the election. The maximum correlation of Republican areas with cumulative COVID cases occurred in the second or third week of January 2021, at 17 cases per 100,000 per percentage point.

<hr>
### Clean, Tidy, and Regress Data
```{r, echo=FALSE, warning=FALSE , message=FALSE, results=FALSE}
library(rmarkdown)
library(data.table)
library(broom)
library(tidyverse)
library(ggdark)
```

#### Import and clean data
```{r}
# pathRona <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
# pathVote <- "https://raw.githubusercontent.com/bhrdj/ronaVote/main/data/vote/Harvard/countypres_2000-2020.csv"
# pathPop <- "https://raw.githubusercontent.com/bhrdj/ronaVote/main/data/countyData/USDA_PopulationData/PopEst2019.csv"

pathRona <- "./data/rona/NYT/us-counties_panel_2021-08-02.csv"
pathVote <- "./data/vote/Harvard/countypres_2000-2020.csv"
pathPop <- "./data/countyData/USDA_PopulationData/PopEst2019.csv"


# Import data
  # Remove rows where FIPS data is missing.
ronaDays <- fread(pathRona, select = 
                grep("fips|date|cases",
                names(fread(pathRona, nrow = 0L)))) %>%
            rename(casesTot = cases)
popu <- fread(pathPop, select = 
                grep("fips|state|area_name|pop2019",
                names(fread(pathPop, nrow = 0L))))
vote <- fread(pathVote, select = 
                grep("year|party|mode|candidate|county_name|county_fips|candidatevotes|totalvotes",
                names(fread(pathVote, nrow = 0L)))) %>%
            rename(fips = county_fips)

rawData <- list(ronaDays=ronaDays, popu=popu, vote=vote) %>%
    map(function(x) { filter(x, !is.na(fips)) })
rm(pathRona, pathVote, pathPop, ronaDays, popu, vote)

# Organize and clean tall (melted) COVID data:
  # Assign a number to each week starting with 2019-12-29.
  # Remove excess rows within weeks.
  # Make crosswalks to text-label versions of the numeric dates and FIPS.

zeroMonday <- as.IDate("2019-12-29")
zeroMondayInt <- as.numeric(zeroMonday)

ronaTall <- rawData[["ronaDays"]] %>%
    mutate(weekNum = (as.numeric(date) - as.numeric(zeroMondayInt)) %/% 7) %>%
    distinct(fips, weekNum, .keep_all = TRUE) %>%
    mutate(weekDate = as.IDate(weekNum * 7, origin=zeroMonday)) %>%
    mutate(week_DateT = paste("T", gsub("-", "_", weekDate), sep="")) %>%
    mutate(fipsText = paste("x", fips, sep = ""))

weekDates <- distinct(ronaTall, week_DateT, weekDate)
fips_fipsText <- distinct(ronaTall, fips, fipsText, .keep_all = FALSE)
```

<hr>
#### Tidy data
```{r}
# Tidy election data:
    # Widen -> 
        # a column for each major party,
        # a row for each FIPS county.
    # Sum votes for FIPS areas with multiple subareas.
    # Calculate vote-margins from vote-counts.

vote_wide <- rawData[["vote"]] %>%
    filter(year == 2020) %>%
    select(-c(year)) %>%
    filter((candidate != "JO JORGENSEN") & (candidate != "OTHER")) %>% 
    pivot_wider(names_from = party, 
                values_from = candidatevotes,
                id_cols = -c(party, candidatevotes, candidate))  %>%
    group_by(fips) %>%
    summarize(DEMOCRAT = sum(DEMOCRAT),
              REPUBLICAN = sum(REPUBLICAN),
              county_name = unique(county_name), 
              totalvotes = unique(totalvotes)) %>%
    mutate(DJT_Margin = (REPUBLICAN - DEMOCRAT) / (REPUBLICAN + DEMOCRAT))

# Tidy COVID data:
    # Widen -> 
        # a column for each week
        # a row for each FIPS county.
    # Join with population and election data.
    # Impute zero-cases for (earlier) weeks where some counties didn't have any cases yet.
ronaSectionsTot_BeforeCleaning <- ronaTall  %>%
    pivot_wider(id_cols = fipsText,
                names_from = week_DateT, 
                values_from = casesTot) %>%
    mutate(across(starts_with("T", ignore.case=FALSE), ~replace_na(., 0)))  %>%
    left_join(fips_fipsText, by = "fipsText") %>%
    left_join(rawData[["popu"]], by="fips") %>%
    left_join(vote_wide, by="fips") %>%
    column_to_rownames(., var = "fipsText")

```

<hr>
#### Review 114 FIPS Code Records Dropped From Dataset for Missing Data
<details><summary>*Warning: Large dropdown window*</summary>
```{r}
# FIND UNCLEAN OBSERVATIONS TO BE DROPPED OR REPAIRED
countiesWithNA_somewhere <- ronaSectionsTot_BeforeCleaning %>% 
    select(c(county_name, DEMOCRAT, REPUBLICAN, totalvotes, pop2019, fips)) %>%
    filter( 
        is.na(DEMOCRAT) |
        is.na(REPUBLICAN) |
        is.na(totalvotes) |
        is.na(fips) | 
        is.na(pop2019)
        )

# VIEW THESE FIPS COUNTIES (MANY SOMEHOW DON'T HAVE NAMES!)
countiesWithNA_somewhere

# DROP THEM
countiesWithNA_fips <- countiesWithNA_somewhere %>%
  select("fips")

ronaSectionsTot <- ronaSectionsTot_BeforeCleaning %>%
    filter( 
      !is.na(DEMOCRAT) &
      !is.na(REPUBLICAN) &
      !is.na(totalvotes) &
      !is.na(fips) &
      !is.na(pop2019)
      )

# STEPS TO FIX:
#   UPDATE TO THE POPULATION DATA BASED ON THE 2020 CENSUS
#   CHECK FOR MORE UPDATES FROM MIT/HARVARD / HOPE THEY FIX THE HOLES IN THEIR ELECTION DATA
#   MANUALLY FIX THE FEW COUNTIES I CAN FROM OTHER DATA ALREADY IN THIS Rmd
#   SLEUTH AROUND MYSELF TO FIND THESE MYSTERY COUNTIES

```
</summary></details>

<hr>
#### Calculate Summary Data
```{r}
# Calculate a column for COVID-cases-per-capita.
ronaPerCap <- ronaSectionsTot %>%
    mutate(across(starts_with("T", ignore.case=FALSE), function(x) {x/pop2019} ))

# Remove unused variables
rm(rawData) #, ronaTall, ronaSectionsTot)

# Calc national summary data
nationalSummaries <- ronaSectionsTot %>%
  select(c("pop2019", "totalvotes", "REPUBLICAN", "DEMOCRAT")) %>%
  mutate(RPlusDVotes= REPUBLICAN + DEMOCRAT) %>%
  colSums()

# Calc USA Aggregate COVID Data
ronaTotalUSA <- ronaSectionsTot %>%
  select(starts_with("T", ignore.case=FALSE)) %>%
  colSums()

# Calc USA Aggregate COVID Data
ronaPerCapUSA <- ronaTotalUSA / nationalSummaries["pop2019"]

```

<hr>
#### Regress
```{r}
# Regress COVID cases-per-capita on election data
    # One regression for each week
    # Each regression across the cross-section of FIPS counties
lm_allT <-  map(select(ronaPerCap, starts_with("T", ignore.case=FALSE)), 
                       function(yvar) {
                         lm(yvar ~ DJT_Margin, ronaPerCap)
                         })

# Tidy regression coefficients and other statistical output.
lm_outT <- map(lm_allT, 
               function(an_lm) {
                   c( tidy(an_lm)$estimate[2], 
                      glance(an_lm)$r.squared,
                      glance(an_lm)$p.value )
               })

lm_dfT <- as.data.frame(do.call(rbind, lm_outT))
colnames(lm_dfT) <- c("BetaCoeff", "RSquared", "PValue")
```

<hr>
#### Make Regression Output Summary Tables
```{r}
# Join additional columns for analysis
timeSeriesResults <- lm_dfT %>% 
  rownames_to_column(var = "week_DateT") %>%
  left_join(weekDates, by = "week_DateT") %>%
  add_column(ronaTotalUSA) %>%
  column_to_rownames("week_DateT") %>%
  filter(weekDate > as.Date("2020-04-12"))

# Reorder columns
timeSeriesResults <- 
  timeSeriesResults[c("BetaCoeff", "ronaTotalUSA", "RSquared", "PValue", "weekDate")]

rm(lm_allT, lm_outT, lm_dfT)
```

<hr>
### Plot Coefficients Over Time
```{r echo=FALSE, warning=FALSE, message=FALSE, results=FALSE}
title_ = "Magnitude of Coefficients Over Time"
subtitle_ = "(Between Percap COVID and 2020 Vote Margin Across USA Counties)"
caption_ = paste(
  "Each data point is a regression coefficient,\n",
  "at a particular week, across all USA FIPS counties, between:\n",
  "per-capita cumulative COVID cases, and\n",
  "the 2020 vote margin.\n\n",
  "A coefficient of +0.01 means that:\n",
  "an increase of +.01 in vote margin (+Republican) would correlate with\n",
  "an increase of +1 COVID case per 10,000 population.")
```

```{r fig.align='center', warning=FALSE, message=FALSE}
Margin_vs_CovidPerCap <- timeSeriesResults %>% 
    ggplot(aes(x=weekDate, 
               y=BetaCoeff)) +
        labs(title=title_, subtitle=subtitle_, caption=caption_) +
        xlab("Date") + ylab("Regression Coefficient") +
        scale_y_continuous(limits=c(-.01, .02)) +
        geom_hline(yintercept = 0, linetype = "solid", color = "white", size = .5) +
        geom_point(aes(color=BetaCoeff)) +
        scale_colour_gradient(low="#0000ff", high="#ff0000", guide=FALSE)

Margin_vs_CovidPerCap + dark_theme_gray()
```

<hr>

### Discussion

#### Overview
Each plotted point on the graph is a cross-section regression coefficient, taken at a point in time. It measures a correlation at that time across the cross-section of all USA FIPS counties, and this is done every week.

The coefficient measures correlation between:
 * per-capita cumulative COVID cases, and
 * the 2020 presidential election vote margin.

Of course, the 2020 vote margin doesn't change, only the cumulative count of COVID cases can change. And, the cumulative counts can never decrease, by definition. When a trend appears, such as counties that voted more-Republican having suffered more cumulative COVID cases, then the coefficient will increase with that trend.

Note that the coefficient was negative in early 2020, when counties that voted more-Democrat initially experienced greater vulnerability to the virus.  Then that switched to the opposite in Fall 2020. 

#### Maximum and minimum values
The maximum correlation of Democratic areas and cumulative severity of COVID occurred at a level of -.008 during the second week of August 2020. That is, +8 COVID cases per 100,000 population per percentage point of Democrat vote margin.  By the second week of November, the Democratic and Republican areas had accumulated balanced counts, at the moment of the election. The maximum correlation of Republican areas with cumulative COVID cases occurred in the second or third week of January 2021 at .017, or 17 cases per 100,000 population per percentage point of vote margin.

<hr>
### Magnitudes in Context
First, we need a table of summary statistics of the USA:
```{r}
nationalSummaries
```
Next, here is a table of the key max and min values from the regression tables, as well as the most recent coefficient.
```{r}
maxMinTable <- timeSeriesResults %>% 
  slice(c(
    which.min(BetaCoeff),
    which.max(BetaCoeff),
    which.min(abs(BetaCoeff)),
    n()
    )) %>%
  mutate(across(c("BetaCoeff", "ronaTotalUSA", "RSquared", "PValue"), ~ signif(.x, digits=3)))

rownames(maxMinTable) <- 
  c("Peak Dem. Coeff",
    "Near-zero Coeff",
    "Peak Rep. Coeff",
    "Current Status")
maxMinTable
```

<hr>
### Interpreting the Magnitude of Coefficients
A coefficient of +.01 naively implies that an change of 1 in the vote margin correlates with an increase in .01 cases per population. But, the vote margin is only relevant in smaller increments, so let's divide by 100.

So, a coefficient of +0.01 means that an increase of +.01 in vote margin (+ defined as + Republican), would correlate with an increase of +1 COVID case per 10,000 population. This "increase" is not happening over time, it is a way of making an incremental comparison between different counties in the cross-section.

Thus, we can say that a correlation of .01 implies that an increase of .01 in vote margin correlates with one additional COVID case per 10,000 population.

Consider an example county with 10,000 Americans, including 5,000 voters, and presume a coefficient of +.01, where Republican votes correlate with more COVID cases.

If the county were to hypothetically move along this margin such that there were 25 more Republican voters and 25 fewer Democrat voters, then that would increase the margin by +.01, corresponding to one additional case in the county.

<hr>
### Correlation, Causality, and References
For now, I must leave it to epidemiologists to publicly cast judgement on how to draw correct inference from this correlation.

This correlation [has](https://www.nytimes.com/interactive/2021/04/17/us/vaccine-hesitancy-politics.html) been [reported](https://www.npr.org/sections/health-shots/2020/11/06/930897912/many-places-hard-hit-by-covid-19-leaned-more-toward-trump-in-2020-than-2016)  since even [before](https://www.washingtonpost.com/politics/2021/07/27/rate-new-infections-is-about-twice-high-red-counties-blue-counties/) the election, but I hope you found this presentation interesting and relevant.

<hr>
### Additional Analysis
 * Plot similar graphs for within-states and between-states coefficients over time.
 * Redo analysis using per-100,000 statistics instead of per-capita
 * Put magnitude of effect in context of aggregate figures

<!--
# if .005 of voters switch their vote, that's a +.01 margin
# +.01 margin corresponds to a total of 155,146,377 * .005 = 775,732 votes
# +.0001 cases per population corresponds to 322,793,363 * +.0001 = 32,279 cases
# 775,732 votes divided by 32,279 cases equals a marginal rate of about 25 votes per case


# CODE AND INFO FOR LATER

# library(shiny)
# library(bslib)
# library(thematic)

# pathRona <- "./data/rona/NYT/us-counties_panel_2021-08-02.csv"
# pathVote <- "./data/vote/Harvard/countypres_2000-2020.csv"
# pathPop <- "./data/countyData/USDA_PopulationData/PopEst2019.csv"

# pathRona <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
# pathVote <- "https://raw.githubusercontent.com/bhrdj/ronaVote/main/data/vote/Harvard/countypres_2000-2020.csv"
# pathPop <- "https://raw.githubusercontent.com/bhrdj/ronaVote/main/data/countyData/USDA_PopulationData/PopEst2019.csv"

# library(rsconnect)
# rsconnect::deployApp('~/git/RmdSandbox/')
# https://bhrdj.shinyapps.io/rmdsandbox/

# https://www.shinyapps.io/admin/#/dashboard

# RUN THESE TO CLEAR LOCAL DATA BUILDING UP IN R WORKSPACE
# rm(list = ls())
# .rs.restartR()

-->
